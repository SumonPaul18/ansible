# ЁЯЫая╕П Ansible Pre-flight Playbook

> **ржЙржжрзНржжрзЗрж╢рзНржп**: ржПржХ ржмрж╛ ржПржХрж╛ржзрж┐ржХ Linux ржЯрж╛рж░рзНржЧрзЗржЯ ржирзЛржбржХрзЗ Ansible ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯрзЗрж░ ржЬржирзНржп рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржкрзНрж░рж╕рзНрждрзБржд ржХрж░рж╛ тАФ SSH key-based authentication, sudo ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕, рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ рж╣рж╛рж░рзНржбрзЗржирж┐ржВ ржПржмржВ ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржкрзНржпрж╛ржХрзЗржЬ ржЗржирж╕рзНржЯрж▓ ржХрж░рзЗред

ржПржЗ playbook ржЯрж┐ ржмрж┐рж╢рзЗрж╖ ржХрж░рзЗ **OpenStack (kolla-ansible)**, **Kubernetes**, ржмрж╛ ржпрзЗржХрзЛржирзЛ DevOps ржУржпрж╝рж╛рж░рзНржХржлрзНрж▓рзЛрж░ ржЖржЧрзЗ ржирзЛржб ржкрзНрж░рж╕рзНрждрзБрждрж┐рж░ ржЬржирзНржп ржбрж┐ржЬрж╛ржЗржи ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред

---

## ЁЯУБ Directory Structure

```
ansible-prep/
тФЬтФАтФА README.md                     # ржПржЗ ржлрж╛ржЗрж▓
тФЬтФАтФА inventory.ini                 # ржЯрж╛рж░рзНржЧрзЗржЯ рж╣рзЛрж╕рзНржЯ(ржЧрзБрж▓рзЛ) ржПржмржВ ржкрзНрж░рж╛ржержорж┐ржХ ржХрзНрж░рзЗржбрзЗржирж╢рж┐ржпрж╝рж╛рж▓
тФЬтФАтФА group_vars/
тФВ   тФФтФАтФА all.yml                   # ржЧрзНрж▓рзЛржмрж╛рж▓ ржнрзНржпрж╛рж░рж┐ржпрж╝рзЗржмрж▓ (ржЗржЙржЬрж╛рж░, SSH key, UFW рж╕рзЗржЯрж┐ржВрж╕)
тФЬтФАтФА roles/
тФВ   тФФтФАтФА preflight/
тФВ       тФЬтФАтФА tasks/main.yml        # ржорзВрж▓ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржЯрж╛рж╕рзНржХрж╕ржорзВрж╣
тФВ       тФФтФАтФА handlers/main.yml     # рж╕рж╛рж░рзНржнрж┐рж╕ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ (SSH)
тФФтФАтФА site.yml                      # ржорзВрж▓ playbook ржПржирзНржЯрзНрж░рж┐ ржкржпрж╝рзЗржирзНржЯ
```

### ЁЯФН ржлрж╛ржЗрж▓ ржмрзНржпрж╛ржЦрзНржпрж╛

| ржлрж╛ржЗрж▓ | ржХрж╛ржЬ |
|------|------|
| `inventory.ini` | ржЯрж╛рж░рзНржЧрзЗржЯ рж╣рзЛрж╕рзНржЯ(ржЧрзБрж▓рзЛ) ржПржмржВ ржкрзНрж░рж╛ржержорж┐ржХ SSH ржХрзНрж░рзЗржбрзЗржирж╢рж┐ржпрж╝рж╛рж▓ (рж╢рзБржзрзБ ржкрзНрж░ржержоржмрж╛рж░рзЗрж░ ржЬржирзНржп) |
| `group_vars/all.yml` | ржХрж╛рж╕рзНржЯржорж╛ржЗржЬрзЗржмрж▓ рж╕рзЗржЯрж┐ржВрж╕: ржЗржЙржЬрж╛рж░ ржирж╛ржо, SSH public key path, UFW enable/disable |
| `roles/preflight/tasks/main.yml` | ржорзВрж▓ ржХрж╛ржЬ: ржкрзНржпрж╛ржХрзЗржЬ ржЗржирж╕рзНржЯрж▓, ржЗржЙржЬрж╛рж░ рждрзИрж░рж┐, sudo ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕, SSH key рж╕рзЗржЯржЖржк, sshd_config ржоржбрж┐ржлрж╛ржЗ |
| `roles/preflight/handlers/main.yml` | SSH рж╕рж╛рж░рзНржнрж┐рж╕ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ ржХрж░рзЗ ржпржЦржи sshd_config ржкрж░рж┐ржмрж░рзНрждржи рж╣ржпрж╝ |
| `site.yml` | playbook ржПрж░ ржПржирзНржЯрзНрж░рж┐ ржкржпрж╝рзЗржирзНржЯ тАФ `preflight` role ржХрж▓ ржХрж░рзЗ |

---

## тЪЩя╕П ржХрж╛рж╕рзНржЯржорж╛ржЗржЬрзЗрж╢ржи ржЧрж╛ржЗржб

### 1. **ржЗржЙржЬрж╛рж░ ржирж╛ржо ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ**
- ржлрж╛ржЗрж▓: `group_vars/all.yml`
- ржкрж░рж┐ржмрж░рзНрждржи:
  ```yaml
  preflight_user: your_custom_user
  ```

### 2. **SSH Public Key ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ**
- ржбрж┐ржлрж▓рзНржЯ: `~/.ssh/id_rsa.pub` (control node ржерзЗржХрзЗ)
- ржЕржирзНржп ржХрзА ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржЪрж╛ржЗрж▓рзЗ:
  ```yaml
  preflight_ssh_pubkey: "{{ lookup('file', '/path/to/your/public.key') }}"
  ```
  ржЕржержмрж╛ рж╕рж░рж╛рж╕рж░рж┐ рж╕рзНржЯрзНрж░рж┐ржВ ржжрж┐ржи:
  ```yaml
  preflight_ssh_pubkey: "ssh-rsa AAAAB3NzaC1yc2E... user@host"
  ```

### 3. **UFW ржмржирзНржз рж░рж╛ржЦрждрзЗ ржЪрж╛ржЗрж▓рзЗ**
- ржлрж╛ржЗрж▓: `group_vars/all.yml`
- ржкрж░рж┐ржмрж░рзНрждржи:
  ```yaml
  enable_ufw: false
  ```

### 4. **ржЕрждрж┐рж░рж┐ржХрзНржд ржкрзЛрж░рзНржЯ ржЕрзНржпрж╛рж▓рж╛ржЙ ржХрж░рждрзЗ (UFW)**
- ржлрж╛ржЗрж▓: `roles/preflight/tasks/main.yml`
- ржирждрзБржи ржЯрж╛рж╕рзНржХ ржпрзЛржЧ ржХрж░рзБржи:
  ```yaml
  - name: Allow HTTP/HTTPS in UFW
    ufw:
      rule: allow
      port: "{{ item }}"
    loop: [80, 443]
    when: enable_ufw
  ```

---

## тЦ╢я╕П Playbook рж░рж╛ржи ржХрж░рж╛рж░ ржЧрж╛ржЗржбрж▓рж╛ржЗржи

### ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ рж╢рж░рзНржд
- **Control Node**: Ansible ржЗржирж╕рзНржЯрж▓ ржерж╛ржХрждрзЗ рж╣ржмрзЗ (`sudo apt install ansible`)
- **Target Node**: рж╢рзБржзрзБржорж╛рждрзНрж░ SSH ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ (ржкрзНрж░ржержоржмрж╛рж░рзЗрж░ ржЬржирзНржп)

### ржзрж╛ржкржЧрзБрж▓рзЛ:

1. **SSH Key ржЬрзЗржирж╛рж░рзЗржЯ ржХрж░рзБржи** (ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ):
   ```bash
   ssh-keygen -t rsa -b 4096
   ```

2. **Inventory ржЖржкржбрзЗржЯ ржХрж░рзБржи** (`inventory.ini`):
   ```ini
   [target]
   192.168.0.94

   [target:vars]
   ansible_user=cloud3
   ansible_ssh_pass=your_actual_password  # рж╢рзБржзрзБ ржкрзНрж░ржержоржмрж╛рж░
   ```

3. **Playbook рж░рж╛ржи ржХрж░рзБржи**:
   ```bash
   cd ansible-prep
   ansible-playbook -i inventory.ini site.yml
   ```

4. **ржкрж░ржмрж░рзНрждрзА ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЬржирзНржп**:
   - `inventory.ini` ржерзЗржХрзЗ `ansible_ssh_pass` рж▓рж╛ржЗржи **ржорзБржЫрзЗ ржлрзЗрж▓рзБржи**
   - ржПржЦржи ржерзЗржХрзЗ key-based auth ржХрж╛ржЬ ржХрж░ржмрзЗ

> тЬЕ **рж╕рзБрж░ржХрзНрж╖рж╛ ржЯрж┐ржк**: ржкрзНрж░рзЛржбрж╛ржХрж╢ржирзЗ `ansible_ssh_pass` ржмрзНржпржмрж╣рж╛рж░ ржирж╛ ржХрж░рзЗ `--ask-pass` ржЕржержмрж╛ `ansible-vault` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

---

## тЬЕ ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи: ржкрж░рж┐ржмрж░рзНрждржиржЧрзБрж▓рзЛ ржЪрзЗржХ ржХрж░рзБржи

Playbook рж╕ржлрж▓ржнрж╛ржмрзЗ рж░рж╛ржи рж╣ржУржпрж╝рж╛рж░ ржкрж░ ржирж┐ржЪрзЗрж░ ржХржорж╛ржирзНржбржЧрзБрж▓рзЛ ржжрж┐ржпрж╝рзЗ ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржи:

```bash
# 1. SSH key-based login ржХрж╛ржЬ ржХрж░ржЫрзЗ?
ssh cloud3@192.168.0.94 'echo "тЬЕ Key auth works!"'

# 2. Password auth ржмржирзНржз рж╣ржпрж╝рзЗржЫрзЗ?
ssh cloud3@192.168.0.94 'grep "^PasswordAuthentication" /etc/ssh/sshd_config'
# ржЖржЙржЯржкрзБржЯ: PasswordAuthentication no

# 3. NOPASSWD sudo ржХрж╛ржЬ ржХрж░ржЫрзЗ?
ssh cloud3@192.168.0.94 'sudo -n whoami'
# ржЖржЙржЯржкрзБржЯ: root (ржХрзЛржирзЛ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЪрж╛ржЗржмрзЗ ржирж╛)

# 4. UFW ржЪрж╛рж▓рзБ ржУ SSH ржЕрзНржпрж╛рж▓рж╛ржЙржб?
ssh cloud3@192.168.0.94 'sudo ufw status verbose'

# 5. ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржкрзНржпрж╛ржХрзЗржЬ ржЗржирж╕рзНржЯрж▓ рж╣ржпрж╝рзЗржЫрзЗ?
ssh cloud3@192.168.0.94 'dpkg -l | grep -E "openssh-server|git|htop"'
```

---

## тЪая╕П рж╕ржорзНржнрж╛ржмрзНржп рждрзНрж░рзБржЯрж┐ ржУ рж╕ржорж╛ржзрж╛ржи

| рждрзНрж░рзБржЯрж┐ | ржХрж╛рж░ржг | рж╕ржорж╛ржзрж╛ржи |
|--------|------|--------|
| **`UNREACHABLE! "Failed to connect to the host via ssh"`** | Target node-ржП SSH ржЪрж╛рж▓рзБ ржирзЗржЗ, ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЗрж╕рзНржпрзБ, ржмрж╛ ржнрзБрж▓ IP | - `ping 192.168.0.94` ржЪрзЗржХ ржХрж░рзБржи<br>- Target-ржП `sudo systemctl status ssh` ржЪрж╛рж▓рж╛ржи<br>- Firewall/UFW ржЪрзЗржХ ржХрж░рзБржи |
| **`Authentication failed`** | ржнрзБрж▓ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржмрж╛ ржЗржЙржЬрж╛рж░ ржирзЗржЗ | - `inventory.ini`-ржП рж╕ржарж┐ржХ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржжрж┐ржи<br>- Target-ржП `id cloud3` ржжрж┐ржпрж╝рзЗ ржЗржЙржЬрж╛рж░ ржЖржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзБржи |
| **`python3 not found`** | Target-ржП Python ржЗржирж╕рзНржЯрж▓ ржирзЗржЗ | Playbook ржкрзНрж░ржержорзЗ `raw` ржоржбрж┐ржЙрж▓ ржжрж┐ржпрж╝рзЗ python3 ржЗржирж╕рзНржЯрж▓ ржХрж░рзЗ тАФ рждржмрзЗ ржпржжрж┐ рждрж╛ ржмрзНржпрж░рзНрже рж╣ржпрж╝, рждрж╛рж╣рж▓рзЗ ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ ржЗржирж╕рзНржЯрж▓ ржХрж░рзБржи: `sudo apt install -y python3` |
| **`sudo: a password is required`** | `cloud3` ржЗржЙржЬрж╛рж░рзЗрж░ sudo ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржирзЗржЗ | Playbook рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ sudoers ржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рзЗ тАФ рждржмрзЗ ржпржжрж┐ ржмрзНржпрж░рзНрже рж╣ржпрж╝, рждрж╛рж╣рж▓рзЗ ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ ржЪрзЗржХ ржХрж░рзБржи: `/etc/sudoers.d/cloud3_nopasswd` |
| **`Failed to restart ssh`** | `sshd_config` рж╕рж┐ржиржЯрзНржпрж╛ржХрзНрж╕ ржПрж░рж░ | - `sudo sshd -t` ржжрж┐ржпрж╝рзЗ config ржЯрзЗрж╕рзНржЯ ржХрж░рзБржи<br>- Playbook ржЕржЯрзЛ ржмрзНржпрж╛ржХржЖржк ржирзЗржпрж╝ (`/etc/ssh/sshd_config.bak`) тАФ рж╕рзЗржЯрж┐ рж░рж┐рж╕рзНржЯрзЛрж░ ржХрж░рзБржи |
| **`lookup plugin (file) failed`** | Control node-ржП `~/.ssh/id_rsa.pub` ржирзЗржЗ | - `ssh-keygen` ржЪрж╛рж▓рж╛ржи<br>- ржЕржержмрж╛ `group_vars/all.yml`-ржП рж╕рж░рж╛рж╕рж░рж┐ public key ржжрж┐ржи |

---

## ЁЯУМ ржирзЛржЯ

- ржПржЗ playbook **idempotent** тАФ ржПржХрж╛ржзрж┐ржХржмрж╛рж░ ржЪрж╛рж▓рж╛рж▓рзЗ ржХрзЛржирзЛ ржбрзБржкрзНрж▓рж┐ржХрзЗржЯ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи рждрзИрж░рж┐ рж╣ржмрзЗ ржирж╛ред
- ржкрзНрж░ржержоржмрж╛рж░ **password-based SSH** ржкрзНрж░ржпрж╝рзЛржЬржи, ржкрж░рзЗ **key-based** рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝ред
- ржЖржкржирж╛рж░ **OpenStack/kolla-ansible** ржбрж┐ржкрзНрж▓ржпрж╝ржорзЗржирзНржЯрзЗрж░ ржЖржЧрзЗ ржПржЯрж┐ ржЪрж╛рж▓рж╛ржирзЛ ржЖржжрж░рзНрж╢ ржкрзНрж░рзНржпрж╛ржХржЯрж┐рж╕ред

---

## ЁЯУм рж╕рж╛ржкрзЛрж░рзНржЯ

ржпржжрж┐ ржЖржкржирж╛рж░ рж▓рзНржпрж╛ржмрзЗ ржХрзЛржирзЛ ржмрж┐рж╢рзЗрж╖ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рж╕рзЗржЯржЖржк (ржпрзЗржоржи VLAN, ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ IP, ржЗрждрзНржпрж╛ржжрж┐) ржерж╛ржХрзЗ, рждрж╛рж╣рж▓рзЗ `group_vars` ржмрж╛ `tasks`-ржП рж╕рзЗржЧрзБрж▓рзЛ ржпрзЛржЧ ржХрж░рж╛ ржпрж╛ржмрзЗред

> тЬи **Happy Automating!**  
> тАФ ржЖржкржирж╛рж░ DevOps рж▓рзНржпрж╛ржмрзЗрж░ ржЬржирзНржп рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред

--- 
