```markdown
# ЁЯЫая╕П Ansible Preflight Playbook

ржПржЗ playbook ржЯрж┐ ржЖржкржирж╛рж░ **target Linux ржирзЛржбржЧрзБрж▓рзЛржХрзЗ Ansible-ржПрж░ ржЬржирзНржп ржкрзНрж░рж╕рзНрждрзБржд** ржХрж░ржмрзЗред  
SSH key setup, sudo access, ржкрзНржпрж╛ржХрзЗржЬ ржЗржирж╕рзНржЯрж▓, UFW ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи тАФ рж╕ржмржХрж┐ржЫрзБ **ржПржХ ржЬрж╛ржпрж╝ржЧрж╛ ржерзЗржХрзЗ ржХрж╛рж╕рзНржЯржорж╛ржЗржЬ** ржХрж░рж╛ ржпрж╛ржмрзЗред

---

## ЁЯУБ Directory Structure

```
ansible-preflight/
тФЬтФАтФА README.md                 # ржПржЗ ржлрж╛ржЗрж▓
тФЬтФАтФА inventory.ini             # ржЯрж╛рж░рзНржЧрзЗржЯ ржирзЛржбрзЗрж░ IP ржУ рж▓ржЧрж┐ржи рждржерзНржп
тФЬтФАтФА group_vars/all.yml        # ЁЯСИ рж╕ржм ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржПржЦрж╛ржирзЗ (ржПржбрж┐ржЯ ржХрж░рзБржи ржПржЦрж╛ржирзЗ)
тФЬтФАтФА site.yml                  # ржорзВрж▓ playbook
тФФтФАтФА roles/preflight/tasks/main.yml  # рж╕ржм ржЯрж╛рж╕рзНржХ (ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ)
```

### ЁЯФН ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛрж░ ржХрж╛ржЬ:

| ржлрж╛ржЗрж▓ | ржХрж╛ржЬ |
|------|------|
| `group_vars/all.yml` | **рж╕ржм ржХрж╛рж╕рзНржЯржорж╛ржЗржЬрзЗрж╢ржи ржПржЦрж╛ржирзЗ**: ржкрзНржпрж╛ржХрзЗржЬ, UFW, sudo, SSH рж╕рзЗржЯрж┐ржВрж╕ |
| `inventory.ini` | ржЯрж╛рж░рзНржЧрзЗржЯ ржирзЛржбрзЗрж░ IP, ржЗржЙржЬрж╛рж░, ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб (рж╢рзБржзрзБ ржкрзНрж░ржержоржмрж╛рж░) |
| `site.yml` | playbook entrypoint тАФ ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ |
| `roles/preflight/tasks/main.yml` | рж▓ржЬрж┐ржХ тАФ рж╕рж╛ржзрж╛рж░ржгржд ржПржбрж┐ржЯ ржХрж░рж╛рж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ |

---

## тЪЩя╕П ржХрзАржнрж╛ржмрзЗ ржХрж╛рж╕рзНржЯржорж╛ржЗржЬ ржХрж░ржмрзЗржи?

рж╕ржм ржкрж░рж┐ржмрж░рзНрждржи **рж╢рзБржзрзБржорж╛рждрзНрж░ `group_vars/all.yml`** ржлрж╛ржЗрж▓рзЗ ржХрж░рзБржи:

### 1. **UFW ржмржирзНржз рж░рж╛ржЦрждрзЗ ржЪрж╛ржи?**
```yaml
configure_ufw: false  # ЁЯСИ ржбрж┐ржлрж▓рзНржЯрзЗ false
```

### 2. **ржкрзНржпрж╛ржХрзЗржЬ ржпрзЛржЧ/ржмрж╛ржж ржжрж┐рждрзЗ ржЪрж╛ржи?**
```yaml
essential_packages:
  - openssh-server
  - curl
  - git
  # - htop    # ржХржорзЗржирзНржЯ ржЖржЙржЯ ржХрж░рзБржи ржмрж╛ржж ржжрж┐рждрзЗ
  - nginx     # ржирждрзБржи ржкрзНржпрж╛ржХрзЗржЬ ржпрзЛржЧ ржХрж░рзБржи
```

### 3. **Passwordless sudo ржЪрж╛ржи ржирж╛?**
```yaml
enable_passwordless_sudo: false
```

### 4. **ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЕржерзЗржирзНржЯрж┐ржХрзЗрж╢ржи ржмржирзНржз ржХрж░ржмрзЗржи ржирж╛?**
```yaml
disable_password_auth: false
```

> тЬЕ ржХрзЛржирзЛ ржХрзЛржб ржкрж░рж┐ржмрж░рзНрждржи ржЫрж╛ржбрж╝рж╛ржЗ рж╕ржм ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи рж╕ржорзНржнржм!

---

## тЦ╢я╕П ржХрзАржнрж╛ржмрзЗ рж░рж╛ржи ржХрж░ржмрзЗржи?

### ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ рж╢рж░рзНржд:
- Control node-ржП **Ansible** ржЗржирж╕рзНржЯрж▓ ржерж╛ржХрждрзЗ рж╣ржмрзЗ
- Target node-ржП **SSH password login** рж╕ржХрзНрж░рж┐ржпрж╝ ржерж╛ржХрждрзЗ рж╣ржмрзЗ (ржЕрж╕рзНржерж╛ржпрж╝рзА)

### ржзрж╛ржкрж╕ржорзВрж╣:

1. **SSH key ржЬрзЗржирж╛рж░рзЗржЯ ржХрж░рзБржи** (ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ):
   ```bash
   ssh-keygen -t rsa -b 4096
   ```

2. **`inventory.ini` ржП ржЯрж╛рж░рзНржЧрзЗржЯ IP ржУ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржжрж┐ржи**:
   ```ini
   [targets]
   192.168.0.94

   [targets:vars]
   ansible_user=cloud3
   ansible_ssh_pass=your_temp_password
   ```

3. **`group_vars/all.yml` ржП ржЖржкржирж╛рж░ ржкржЫржирзНржжржорждрзЛ ржХржиржлрж┐ржЧ ржХрж░рзБржи**

4. **Playbook рж░рж╛ржи ржХрж░рзБржи**:
   ```bash
   ansible-playbook -i inventory.ini site.yml
   ```

5. **ржкрзНрж░ржержо рж░рж╛ржи рж╢рзЗрж╖рзЗ**, `inventory.ini` ржерзЗржХрзЗ `ansible_ssh_pass` рж▓рж╛ржЗржиржЯрж┐ **ржорзБржЫрзЗ ржлрзЗрж▓рзБржи**ред  
   ржПржЦржи ржерзЗржХрзЗ **SSH key** ржжрж┐ржпрж╝рзЗржЗ рж▓ржЧрж┐ржи рж╣ржмрзЗред

---

## тЬЕ ржнрзЗрж░рж┐ржлрж╛ржЗ ржХрж░рзБржи: ржХрзА ржХрзА ржкрж░рж┐ржмрж░рзНрждржи рж╣ржпрж╝рзЗржЫрзЗ?

рж░рж╛ржи рж╢рзЗрж╖рзЗ ржирж┐ржЪрзЗрж░ ржХржорж╛ржирзНржбржЧрзБрж▓рзЛ ржжрж┐ржпрж╝рзЗ ржЪрзЗржХ ржХрж░рзБржи:

```bash
# 1. SSH key ржжрж┐ржпрж╝рзЗ рж▓ржЧрж┐ржи рж╣ржпрж╝ ржХрж┐ржирж╛?
ssh cloud3@192.168.0.94

# 2. sudo ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЫрж╛ржбрж╝рж╛ ржХрж╛ржЬ ржХрж░рзЗ ржХрж┐ржирж╛?
ssh cloud3@192.168.0.94 "sudo -n whoami"  # ржЖржЙржЯржкрзБржЯ: root

# 3. Password auth ржмржирзНржз рж╣ржпрж╝рзЗржЫрзЗ ржХрж┐ржирж╛?
ssh cloud3@192.168.0.94 "grep 'PasswordAuthentication' /etc/ssh/sshd_config"

# 4. UFW ржЪрж╛рж▓рзБ рж╣ржпрж╝рзЗржЫрзЗ ржХрж┐ржирж╛? (ржпржжрж┐ configure_ufw=true рж╣ржпрж╝)
ssh cloud3@192.168.0.94 "sudo ufw status verbose"
```

---

## тЭМ рж╕ржорзНржнрж╛ржмрзНржп рждрзНрж░рзБржЯрж┐ ржУ рж╕ржорж╛ржзрж╛ржи

| рждрзНрж░рзБржЯрж┐ | ржХрж╛рж░ржг | рж╕ржорж╛ржзрж╛ржи |
|--------|------|--------|
| `Authentication failed` | ржнрзБрж▓ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржмрж╛ ржЗржЙржЬрж╛рж░ ржирзЗржЗ | `inventory.ini` ржЪрзЗржХ ржХрж░рзБржи; target-ржП ржЗржЙржЬрж╛рж░ ржЖржЫрзЗ ржХрж┐ржирж╛ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи |
| `python3 not found` | Target-ржП Python ржирзЗржЗ | `ensure_python3: true` рж░рж╛ржЦрзБржи (ржбрж┐ржлрж▓рзНржЯрзЗ true) |
| `Failed to connect to UFW` | UFW ржЗржирж╕рзНржЯрж▓ ржирзЗржЗ | `essential_packages`-ржП `ufw` ржпрзЛржЧ ржХрж░рзБржи ржЕржержмрж╛ `install_essential_packages: true` рж░рж╛ржЦрзБржи |
| `Permission denied (publickey)` | SSH key рж╕ржарж┐ржХржнрж╛ржмрзЗ рж╕рзЗржЯ рж╣ржпрж╝ржирж┐ | Control node-ржП `~/.ssh/id_rsa.pub` ржЖржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзБржи |
| `sudo: a password is required` | sudoers ржлрж╛ржЗрж▓ рж╕ржарж┐ржХ ржиржпрж╝ | `enable_passwordless_sudo: true` рж░рж╛ржЦрзБржи ржПржмржВ playbook рж░рж╛ржи ржХрж░рзБржи |

> ЁЯТб **ржЯрж┐ржк**: ржкрзНрж░ржержоржмрж╛рж░ `--ask-pass` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЗржиржкрзБржЯ ржирж┐ржи:
> ```bash
> ansible-playbook -i inventory.ini site.yml --ask-pass
> ```

---

## ЁЯОп ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЙржжрж╛рж╣рж░ржг

### ржЙржжрж╛рж╣рж░ржг 1: рж╢рзБржзрзБ SSH key + sudo, ржХрзЛржирзЛ ржкрзНржпрж╛ржХрзЗржЬ/UFW ржиржпрж╝
```yaml
install_essential_packages: false
configure_ufw: false
enable_passwordless_sudo: true
```

### ржЙржжрж╛рж╣рж░ржг 2: OpenStack ржирзЛржбрзЗрж░ ржЬржирзНржп (ржЖржкржирж╛рж░ ржХрзЗрж╕)
```yaml
essential_packages:
  - openssh-server
  - python3
  - vim
  - git
  - curl
  - net-tools
configure_ufw: false   # OpenStack ржирж┐ржЬрзЗ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржорзНржпрж╛ржирзЗржЬ ржХрж░рзЗ
```

---

> тЬи **ржПржЗ playbook ржЯрж┐ ржЖржкржирж╛рж░ DevOps/Cloud рж▓рзНржпрж╛ржм, OpenStack ржбрж┐ржкрзНрж▓ржпрж╝ржорзЗржирзНржЯ, ржмрж╛ ржпрзЗржХрзЛржирзЛ ржЕржЯрзЛржорзЗрж╢ржи ржкрзНрж░ржЬрзЗржХрзНржЯрзЗрж░ ржЬржирзНржп ржЖржжрж░рзНрж╢ рж╢рзБрж░рзБрж░ ржкржпрж╝рзЗржирзНржЯ!**
```

---

## ЁЯОБ ржмрзЛржирж╛рж╕: ржкрзНрж░ржержо рж░рж╛ржирзЗрж░ ржЬржирзНржп рж╕рзЗржлржЯрж┐ ржЯрж┐ржк

ржпржжрж┐ `cloud3` ржЗржЙржЬрж╛рж░ ржирж╛ ржерж╛ржХрзЗ, ржкрзНрж░ржержорзЗ ржПржХржЯрж┐ рж╕рж╛ржжрж╛ржорж╛ржЯрж╛ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржжрж┐ржпрж╝рзЗ рждрзИрж░рж┐ ржХрж░рзБржи:

```bash
ssh root@192.168.0.94 "useradd -m -s /bin/bash cloud3 && echo 'cloud3:temp123' | chpasswd && usermod -aG sudo cloud3"
```

рждрж╛рж░ржкрж░ playbook рж░рж╛ржи ржХрж░рзБржиред

---

ржПржЗ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ ржЖржкржирж╛рж░ **8+ ржмржЫрж░рзЗрж░ DevOps/Cloud ржЕржнрж┐ржЬрзНржЮрждрж╛рж░** рж╕рж╛ржерзЗ ржкрзБрж░рзЛржкрзБрж░рж┐ ржорзНржпрж╛ржЪ ржХрж░ржмрзЗ тАФ рж╕рж╣ржЬ, ржиржоржирзАржпрж╝, ржПржмржВ ржкрзБржиржГржмрзНржпржмрж╣рж╛рж░ржпрзЛржЧрзНржпред  
ржЪрж╛ржЗрж▓рзЗ ржПржЯрж┐ржХрзЗ **GitHub template** ржмрж╛ **Ansible Collection** рж╣рж┐рж╕рзЗржмрзЗржУ ржкрзНржпрж╛ржХрзЗржЬ ржХрж░рзЗ ржжрж┐рждрзЗ ржкрж╛рж░рж┐ред